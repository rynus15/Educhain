import { Injectable, inject, NgZone } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { coerceElement } from '@angular/cdk/coercion';
import { Observable, Subject, take, merge, finalize, fromEvent, switchMap, takeUntil, takeWhile } from 'rxjs';
import BezierEasing from './bezier-easing';
import { SMOOTH_SCROLL_OPTIONS } from './smooth-scroll.model';
import * as i0 from "@angular/core";
export class SmoothScrollManager {
    constructor() {
        this.document = inject(DOCUMENT);
        this.zone = inject(NgZone);
        // Default options
        this._defaultOptions = inject(SMOOTH_SCROLL_OPTIONS);
        // Keeps track of the ongoing SmoothScroll functions, so they can be handled in case of duplication.
        // Each scrolled element gets a destroyer stream which gets deleted immediately after it completes.
        // Purpose: If user called a scroll function again on the same element before the scrolls completes,
        // it cancels the ongoing scroll and starts a new one
        this.onGoingScrolls = new Map();
    }
    /**
     * Timing method
     */
    get now() {
        return this.document.defaultView.performance?.now?.bind(this.document.defaultView.performance) || Date.now;
    }
    /**
     * changes scroll position inside an element
     */
    scrollElement(el, x, y) {
        el.scrollLeft = x;
        el.scrollTop = y;
    }
    /**
     * Handles a given parameter of type HTMLElement, ElementRef or selector
     */
    getElement(el, parent) {
        if (typeof el === 'string') {
            return (parent || this.document).querySelector(el);
        }
        return coerceElement(el);
    }
    /**
     * Initializes a destroyer stream, re-initializes it if the element is already being scrolled
     */
    getScrollDestroyerRef(el) {
        if (this.onGoingScrolls.has(el)) {
            this.onGoingScrolls.get(el).next();
        }
        return this.onGoingScrolls.set(el, new Subject()).get(el);
    }
    /**
     * A function called recursively that, given a context, steps through scrolling
     */
    step(context) {
        return new Observable((subscriber) => {
            let elapsed = (this.now() - context.startTime) / context.duration;
            // avoid elapsed times higher than one
            elapsed = elapsed > 1 ? 1 : elapsed;
            // apply easing to elapsed time
            const value = context.easing(elapsed);
            context.currentX = context.startX + (context.x - context.startX) * value;
            context.currentY = context.startY + (context.y - context.startY) * value;
            this.scrollElement(context.scrollable, context.currentX, context.currentY);
            // Proceed to the step
            requestAnimationFrame(() => {
                subscriber.next();
                subscriber.complete();
            });
        });
    }
    /**
     * Checks if smooth scroll has reached, cleans up the smooth scroll stream
     */
    isReached(context, destroyed) {
        if (context.currentX === context.x && context.currentY === context.y) {
            // IMPORTANT: Destroy the stream when scroll is reached ASAP!
            destroyed.next();
            return true;
        }
        return false;
    }
    /**
     * Scroll recursively until coordinates are reached
     * @param context
     * @param destroyed
     */
    scrolling(context, destroyed) {
        return this.step(context).pipe(
        // Continue while target coordinates hasn't reached yet
        takeWhile(() => !this.isReached(context, destroyed)), switchMap(() => this.scrolling(context, destroyed)));
    }
    /**
     * Deletes the destroyer function, runs if the smooth scroll has finished or interrupted
     */
    onScrollReached(el, resolve, destroyed) {
        destroyed.complete();
        this.onGoingScrolls.delete(el);
        this.zone.run(() => resolve());
    }
    /**
     * Terminates an ongoing smooth scroll
     */
    interrupted(el, destroyed) {
        return merge(fromEvent(el, 'wheel', { passive: true, capture: true }), fromEvent(el, 'touchmove', { passive: true, capture: true }), destroyed).pipe(take(1));
    }
    applyScrollToOptions(el, options) {
        if (!options.duration) {
            this.scrollElement(el, options.left, options.top);
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            this.zone.runOutsideAngular(() => {
                // Initialize a destroyer stream, reinitialize it if the element is already being scrolled
                const destroyed = this.getScrollDestroyerRef(el);
                const context = {
                    scrollable: el,
                    startTime: this.now(),
                    startX: el.scrollLeft,
                    startY: el.scrollTop,
                    x: options.left == null ? el.scrollLeft : ~~options.left,
                    y: options.top == null ? el.scrollTop : ~~options.top,
                    duration: options.duration,
                    easing: BezierEasing(options.easing.x1, options.easing.y1, options.easing.x2, options.easing.y2)
                };
                this.scrolling(context, destroyed).pipe(
                // Continue until interrupted by another scroll (new smooth scroll / wheel / touchmove)
                takeUntil(this.interrupted(el, destroyed)), 
                // Once finished, clean up the destroyer stream and resolve the promise
                finalize(() => this.onScrollReached(el, resolve, destroyed))).subscribe();
            });
        });
    }
    /**
     * Scrolls to the specified offsets. This is a normalized version of the browser's native scrollTo
     * method, since browsers are not consistent about what scrollLeft means in RTL. For this method
     * left and right always refer to the left and right side of the scrolling container irrespective
     * of the layout direction. start and end refer to left and right in an LTR context and vice-versa
     * in an RTL context.
     * @param scrollable element
     * @param customOptions specified the offsets to scroll to.
     */
    scrollTo(scrollable, customOptions) {
        const el = this.getElement(scrollable);
        const isRtl = getComputedStyle(el).direction === 'rtl';
        const options = {
            ...this._defaultOptions,
            ...customOptions,
            ...{
                // Rewrite start & end offsets as right or left offsets.
                left: customOptions.left == null ? (isRtl ? customOptions.end : customOptions.start) : customOptions.left,
                right: customOptions.right == null ? (isRtl ? customOptions.start : customOptions.end) : customOptions.right
            }
        };
        // Rewrite the bottom offset as a top offset.
        if (options.bottom != null) {
            options.top = el.scrollHeight - el.clientHeight - options.bottom;
        }
        // Rewrite the right offset as a left offset.
        if (isRtl) {
            if (options.left != null) {
                options.right = el.scrollWidth - el.clientWidth - options.left;
            }
            options.left = options.right ? -options.right : options.right;
        }
        else {
            if (options.right != null) {
                options.left = el.scrollWidth - el.clientWidth - options.right;
            }
        }
        return this.applyScrollToOptions(el, options);
    }
    /**
     * Scroll to element by reference or selector
     */
    scrollToElement(scrollable, target, customOptions = {}) {
        const scrollableEl = this.getElement(scrollable);
        const targetEl = this.getElement(target, scrollableEl);
        const isRtl = getComputedStyle(scrollableEl).direction === 'rtl';
        if (!targetEl || !scrollableEl) {
            return Promise.resolve();
        }
        const scrollableRect = scrollableEl.getBoundingClientRect();
        const targetRect = targetEl.getBoundingClientRect();
        const options = {
            ...this._defaultOptions,
            ...customOptions,
            ...{
                top: targetRect.top + scrollableEl.scrollTop - scrollableRect.top + (customOptions.top || 0),
                // Rewrite start & end offsets as right or left offsets.
                left: customOptions.left == null ? (isRtl ? customOptions.end : customOptions.start) : customOptions.left,
                right: customOptions.right == null ? (isRtl ? customOptions.start : customOptions.end) : customOptions.right
            }
        };
        if (customOptions.center) {
            // Calculate the center of the container
            const containerCenterX = scrollableRect.left + scrollableRect.width / 2;
            const containerCenterY = scrollableRect.top + scrollableRect.height / 2;
            // Calculate the target's position relative to the container
            const targetCenterX = targetRect.left + targetRect.width / 2;
            const targetCenterY = targetRect.top + targetRect.height / 2;
            // Calculate the scroll position to center the target element in the container
            options.left = targetCenterX - containerCenterX + scrollableEl.scrollLeft;
            options.top = targetCenterY - containerCenterY + scrollableEl.scrollTop;
            return this.applyScrollToOptions(scrollableEl, options);
        }
        if (options.bottom != null) {
            const bottomEdge = scrollableRect.height - targetRect.height;
            options.top = targetRect.top + scrollableEl.scrollTop - scrollableRect.top - bottomEdge + (customOptions.bottom || 0);
        }
        // Rewrite the right offset as a left offset.
        if (isRtl) {
            options.left = targetRect.left - scrollableRect.left + scrollableEl.scrollLeft + (options.left || 0);
            if (options.right != null) {
                options.left = targetRect.right - scrollableRect.left + scrollableEl.scrollLeft - scrollableRect.width + (options.right || 0);
            }
        }
        else {
            options.left = targetRect.left - scrollableRect.left + scrollableEl.scrollLeft + (options.left || 0);
            if (options.right != null) {
                options.left = targetRect.right - scrollableRect.left + scrollableEl.scrollLeft - scrollableRect.width + (options.right || 0);
            }
        }
        const computedOptions = {
            top: options.top,
            left: options.left,
            easing: options.easing,
            duration: options.duration
        };
        return this.applyScrollToOptions(scrollableEl, computedOptions);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: SmoothScrollManager, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: SmoothScrollManager, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.11", ngImport: i0, type: SmoothScrollManager, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic21vb3RoLXNjcm9sbC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zbW9vdGgtc2Nyb2xsL3NyYy9zbW9vdGgtc2Nyb2xsLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWMsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxFQUNMLFVBQVUsRUFFVixPQUFPLEVBQ1AsSUFBSSxFQUNKLEtBQUssRUFDTCxRQUFRLEVBQ1IsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNWLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxZQUFZLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUNMLHFCQUFxQixFQU10QixNQUFNLHVCQUF1QixDQUFDOztBQUsvQixNQUFNLE9BQU8sbUJBQW1CO0lBSGhDO1FBS1UsYUFBUSxHQUFhLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV0QyxTQUFJLEdBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXRDLGtCQUFrQjtRQUNELG9CQUFlLEdBQXdCLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRXRGLG9HQUFvRztRQUNwRyxtR0FBbUc7UUFDbkcsb0dBQW9HO1FBQ3BHLHFEQUFxRDtRQUM3QyxtQkFBYyxHQUFnQyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztLQXlQekY7SUF2UEM7O09BRUc7SUFDSCxJQUFZLEdBQUc7UUFDYixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDN0csQ0FBQztJQUVEOztPQUVHO0lBQ0ssYUFBYSxDQUFDLEVBQVcsRUFBRSxDQUFTLEVBQUUsQ0FBUztRQUNyRCxFQUFFLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNsQixFQUFFLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxVQUFVLENBQUMsRUFBaUMsRUFBRSxNQUFnQjtRQUNwRSxJQUFJLE9BQU8sRUFBRSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzNCLE9BQU8sQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQ0QsT0FBTyxhQUFhLENBQVUsRUFBRSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVEOztPQUVHO0lBQ0sscUJBQXFCLENBQUMsRUFBVztRQUN2QyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDaEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckMsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLElBQUksT0FBTyxFQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVEOztPQUVHO0lBQ0ssSUFBSSxDQUFDLE9BQXlCO1FBQ3BDLE9BQU8sSUFBSSxVQUFVLENBQUMsQ0FBQyxVQUE0QixFQUFFLEVBQUU7WUFDckQsSUFBSSxPQUFPLEdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFFMUUsc0NBQXNDO1lBQ3RDLE9BQU8sR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUVwQywrQkFBK0I7WUFDL0IsTUFBTSxLQUFLLEdBQVcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUU5QyxPQUFPLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDekUsT0FBTyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBRXpFLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMzRSxzQkFBc0I7WUFDdEIscUJBQXFCLENBQUMsR0FBRyxFQUFFO2dCQUN6QixVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xCLFVBQVUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN4QixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssU0FBUyxDQUFDLE9BQXlCLEVBQUUsU0FBd0I7UUFDbkUsSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLE9BQU8sQ0FBQyxDQUFDLElBQUksT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDckUsNkRBQTZEO1lBQzdELFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNqQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsU0FBUyxDQUFDLE9BQXlCLEVBQUUsU0FBd0I7UUFDM0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUk7UUFDNUIsdURBQXVEO1FBQ3ZELFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLEVBQ3BELFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUNwRCxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ssZUFBZSxDQUFDLEVBQVcsRUFBRSxPQUFtQixFQUFFLFNBQXdCO1FBQ2hGLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7T0FFRztJQUNLLFdBQVcsQ0FBQyxFQUFXLEVBQUUsU0FBd0I7UUFDdkQsT0FBTyxLQUFLLENBQ1YsU0FBUyxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUN4RCxTQUFTLENBQUMsRUFBRSxFQUFFLFdBQVcsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQzVELFNBQVMsQ0FDVixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRU8sb0JBQW9CLENBQUMsRUFBVyxFQUFFLE9BQThCO1FBQ3RFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEQsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUVELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFtQixFQUFFLEVBQUU7WUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7Z0JBQy9CLDBGQUEwRjtnQkFDMUYsTUFBTSxTQUFTLEdBQWtCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFaEUsTUFBTSxPQUFPLEdBQXFCO29CQUNoQyxVQUFVLEVBQUUsRUFBRTtvQkFDZCxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDckIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxVQUFVO29CQUNyQixNQUFNLEVBQUUsRUFBRSxDQUFDLFNBQVM7b0JBQ3BCLENBQUMsRUFBRSxPQUFPLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJO29CQUN4RCxDQUFDLEVBQUUsT0FBTyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRztvQkFDckQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRO29CQUMxQixNQUFNLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2lCQUNqRyxDQUFDO2dCQUVGLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLElBQUk7Z0JBQ3JDLHVGQUF1RjtnQkFDdkYsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUMxQyx1RUFBdUU7Z0JBQ3ZFLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FDN0QsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsUUFBUSxDQUFDLFVBQStCLEVBQUUsYUFBb0M7UUFDNUUsTUFBTSxFQUFFLEdBQVksSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRCxNQUFNLEtBQUssR0FBWSxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDO1FBRWhFLE1BQU0sT0FBTyxHQUEwQjtZQUNyQyxHQUFHLElBQUksQ0FBQyxlQUFlO1lBQ3ZCLEdBQUcsYUFBYTtZQUNoQixHQUFHO2dCQUNELHdEQUF3RDtnQkFDeEQsSUFBSSxFQUFFLGFBQWEsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsSUFBSTtnQkFDekcsS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSzthQUM3RztTQUNGLENBQUM7UUFFRiw2Q0FBNkM7UUFDN0MsSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO1lBQzNCLE9BQU8sQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDbkUsQ0FBQztRQUVELDZDQUE2QztRQUM3QyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsSUFBSSxPQUFPLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUN6QixPQUFPLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ2pFLENBQUM7WUFDRCxPQUFPLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUNoRSxDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDMUIsT0FBTyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUNqRSxDQUFDO1FBQ0gsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlLENBQUMsVUFBK0IsRUFBRSxNQUEyQixFQUFFLGdCQUE4QyxFQUFFO1FBQzVILE1BQU0sWUFBWSxHQUFZLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUQsTUFBTSxRQUFRLEdBQVksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDaEUsTUFBTSxLQUFLLEdBQVksZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQztRQUUxRSxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDL0IsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDM0IsQ0FBQztRQUVELE1BQU0sY0FBYyxHQUFZLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3JFLE1BQU0sVUFBVSxHQUFZLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRTdELE1BQU0sT0FBTyxHQUEwQjtZQUNyQyxHQUFHLElBQUksQ0FBQyxlQUFlO1lBQ3ZCLEdBQUcsYUFBYTtZQUNoQixHQUFHO2dCQUNELEdBQUcsRUFBRSxVQUFVLENBQUMsR0FBRyxHQUFHLFlBQVksQ0FBQyxTQUFTLEdBQUcsY0FBYyxDQUFDLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUM1Rix3REFBd0Q7Z0JBQ3hELElBQUksRUFBRSxhQUFhLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUk7Z0JBQ3pHLEtBQUssRUFBRSxhQUFhLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLEtBQUs7YUFDN0c7U0FDRixDQUFDO1FBRUYsSUFBSSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDekIsd0NBQXdDO1lBQ3hDLE1BQU0sZ0JBQWdCLEdBQUcsY0FBYyxDQUFDLElBQUksR0FBRyxjQUFjLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUN4RSxNQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQyxHQUFHLEdBQUcsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFFeEUsNERBQTREO1lBQzVELE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7WUFDN0QsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUU3RCw4RUFBOEU7WUFDOUUsT0FBTyxDQUFDLElBQUksR0FBRyxhQUFhLEdBQUcsZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQztZQUMxRSxPQUFPLENBQUMsR0FBRyxHQUFHLGFBQWEsR0FBRyxnQkFBZ0IsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDO1lBQ3hFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO1lBQzNCLE1BQU0sVUFBVSxHQUFXLGNBQWMsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztZQUNyRSxPQUFPLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEdBQUcsWUFBWSxDQUFDLFNBQVMsR0FBRyxjQUFjLENBQUMsR0FBRyxHQUFHLFVBQVUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEgsQ0FBQztRQUVELDZDQUE2QztRQUM3QyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsT0FBTyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxHQUFHLGNBQWMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLFVBQVUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckcsSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUMxQixPQUFPLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsVUFBVSxHQUFHLGNBQWMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hJLENBQUM7UUFDSCxDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JHLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQztnQkFDMUIsT0FBTyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLFVBQVUsR0FBRyxjQUFjLENBQUMsS0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNoSSxDQUFDO1FBQ0gsQ0FBQztRQUVELE1BQU0sZUFBZSxHQUEwQjtZQUM3QyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7WUFDaEIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQ2xCLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7U0FDM0IsQ0FBQTtRQUVELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksRUFBRSxlQUFlLENBQUMsQ0FBQztJQUNsRSxDQUFDOytHQXJRVSxtQkFBbUI7bUhBQW5CLG1CQUFtQixjQUZsQixNQUFNOzs0RkFFUCxtQkFBbUI7a0JBSC9CLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgaW5qZWN0LCBFbGVtZW50UmVmLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBjb2VyY2VFbGVtZW50IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcclxuaW1wb3J0IHtcclxuICBPYnNlcnZhYmxlLFxyXG4gIFN1YnNjcmliZXIsXHJcbiAgU3ViamVjdCxcclxuICB0YWtlLFxyXG4gIG1lcmdlLFxyXG4gIGZpbmFsaXplLFxyXG4gIGZyb21FdmVudCxcclxuICBzd2l0Y2hNYXAsXHJcbiAgdGFrZVVudGlsLFxyXG4gIHRha2VXaGlsZVxyXG59IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgQmV6aWVyRWFzaW5nIGZyb20gJy4vYmV6aWVyLWVhc2luZyc7XHJcbmltcG9ydCB7XHJcbiAgU01PT1RIX1NDUk9MTF9PUFRJT05TLFxyXG4gIFNtb290aFNjcm9sbEVsZW1lbnQsXHJcbiAgU21vb3RoU2Nyb2xsU3RlcCxcclxuICBTbW9vdGhTY3JvbGxUb0VsZW1lbnRPcHRpb25zLFxyXG4gIFNtb290aFNjcm9sbE9wdGlvbnMsXHJcbiAgU21vb3RoU2Nyb2xsVG9PcHRpb25zXHJcbn0gZnJvbSAnLi9zbW9vdGgtc2Nyb2xsLm1vZGVsJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNtb290aFNjcm9sbE1hbmFnZXIge1xyXG5cclxuICBwcml2YXRlIGRvY3VtZW50OiBEb2N1bWVudCA9IGluamVjdChET0NVTUVOVCk7XHJcblxyXG4gIHByaXZhdGUgem9uZTogTmdab25lID0gaW5qZWN0KE5nWm9uZSk7XHJcblxyXG4gIC8vIERlZmF1bHQgb3B0aW9uc1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2RlZmF1bHRPcHRpb25zOiBTbW9vdGhTY3JvbGxPcHRpb25zID0gaW5qZWN0KFNNT09USF9TQ1JPTExfT1BUSU9OUyk7XHJcblxyXG4gIC8vIEtlZXBzIHRyYWNrIG9mIHRoZSBvbmdvaW5nIFNtb290aFNjcm9sbCBmdW5jdGlvbnMsIHNvIHRoZXkgY2FuIGJlIGhhbmRsZWQgaW4gY2FzZSBvZiBkdXBsaWNhdGlvbi5cclxuICAvLyBFYWNoIHNjcm9sbGVkIGVsZW1lbnQgZ2V0cyBhIGRlc3Ryb3llciBzdHJlYW0gd2hpY2ggZ2V0cyBkZWxldGVkIGltbWVkaWF0ZWx5IGFmdGVyIGl0IGNvbXBsZXRlcy5cclxuICAvLyBQdXJwb3NlOiBJZiB1c2VyIGNhbGxlZCBhIHNjcm9sbCBmdW5jdGlvbiBhZ2FpbiBvbiB0aGUgc2FtZSBlbGVtZW50IGJlZm9yZSB0aGUgc2Nyb2xscyBjb21wbGV0ZXMsXHJcbiAgLy8gaXQgY2FuY2VscyB0aGUgb25nb2luZyBzY3JvbGwgYW5kIHN0YXJ0cyBhIG5ldyBvbmVcclxuICBwcml2YXRlIG9uR29pbmdTY3JvbGxzOiBNYXA8RWxlbWVudCwgU3ViamVjdDx2b2lkPj4gPSBuZXcgTWFwPEVsZW1lbnQsIFN1YmplY3Q8dm9pZD4+KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRpbWluZyBtZXRob2RcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBub3coKTogKCkgPT4gbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3LnBlcmZvcm1hbmNlPy5ub3c/LmJpbmQodGhpcy5kb2N1bWVudC5kZWZhdWx0Vmlldy5wZXJmb3JtYW5jZSkgfHwgRGF0ZS5ub3c7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBjaGFuZ2VzIHNjcm9sbCBwb3NpdGlvbiBpbnNpZGUgYW4gZWxlbWVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2Nyb2xsRWxlbWVudChlbDogRWxlbWVudCwgeDogbnVtYmVyLCB5OiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGVsLnNjcm9sbExlZnQgPSB4O1xyXG4gICAgZWwuc2Nyb2xsVG9wID0geTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhhbmRsZXMgYSBnaXZlbiBwYXJhbWV0ZXIgb2YgdHlwZSBIVE1MRWxlbWVudCwgRWxlbWVudFJlZiBvciBzZWxlY3RvclxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RWxlbWVudChlbDogRWxlbWVudCB8IEVsZW1lbnRSZWYgfCBzdHJpbmcsIHBhcmVudD86IEVsZW1lbnQpOiBFbGVtZW50IHtcclxuICAgIGlmICh0eXBlb2YgZWwgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgIHJldHVybiAocGFyZW50IHx8IHRoaXMuZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3IoZWwpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGNvZXJjZUVsZW1lbnQ8RWxlbWVudD4oZWwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5pdGlhbGl6ZXMgYSBkZXN0cm95ZXIgc3RyZWFtLCByZS1pbml0aWFsaXplcyBpdCBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IGJlaW5nIHNjcm9sbGVkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRTY3JvbGxEZXN0cm95ZXJSZWYoZWw6IEVsZW1lbnQpOiBTdWJqZWN0PHZvaWQ+IHtcclxuICAgIGlmICh0aGlzLm9uR29pbmdTY3JvbGxzLmhhcyhlbCkpIHtcclxuICAgICAgdGhpcy5vbkdvaW5nU2Nyb2xscy5nZXQoZWwpLm5leHQoKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLm9uR29pbmdTY3JvbGxzLnNldChlbCwgbmV3IFN1YmplY3Q8dm9pZD4oKSkuZ2V0KGVsKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEEgZnVuY3Rpb24gY2FsbGVkIHJlY3Vyc2l2ZWx5IHRoYXQsIGdpdmVuIGEgY29udGV4dCwgc3RlcHMgdGhyb3VnaCBzY3JvbGxpbmdcclxuICAgKi9cclxuICBwcml2YXRlIHN0ZXAoY29udGV4dDogU21vb3RoU2Nyb2xsU3RlcCk6IE9ic2VydmFibGU8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChzdWJzY3JpYmVyOiBTdWJzY3JpYmVyPHZvaWQ+KSA9PiB7XHJcbiAgICAgIGxldCBlbGFwc2VkOiBudW1iZXIgPSAodGhpcy5ub3coKSAtIGNvbnRleHQuc3RhcnRUaW1lKSAvIGNvbnRleHQuZHVyYXRpb247XHJcblxyXG4gICAgICAvLyBhdm9pZCBlbGFwc2VkIHRpbWVzIGhpZ2hlciB0aGFuIG9uZVxyXG4gICAgICBlbGFwc2VkID0gZWxhcHNlZCA+IDEgPyAxIDogZWxhcHNlZDtcclxuXHJcbiAgICAgIC8vIGFwcGx5IGVhc2luZyB0byBlbGFwc2VkIHRpbWVcclxuICAgICAgY29uc3QgdmFsdWU6IG51bWJlciA9IGNvbnRleHQuZWFzaW5nKGVsYXBzZWQpO1xyXG5cclxuICAgICAgY29udGV4dC5jdXJyZW50WCA9IGNvbnRleHQuc3RhcnRYICsgKGNvbnRleHQueCAtIGNvbnRleHQuc3RhcnRYKSAqIHZhbHVlO1xyXG4gICAgICBjb250ZXh0LmN1cnJlbnRZID0gY29udGV4dC5zdGFydFkgKyAoY29udGV4dC55IC0gY29udGV4dC5zdGFydFkpICogdmFsdWU7XHJcblxyXG4gICAgICB0aGlzLnNjcm9sbEVsZW1lbnQoY29udGV4dC5zY3JvbGxhYmxlLCBjb250ZXh0LmN1cnJlbnRYLCBjb250ZXh0LmN1cnJlbnRZKTtcclxuICAgICAgLy8gUHJvY2VlZCB0byB0aGUgc3RlcFxyXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xyXG4gICAgICAgIHN1YnNjcmliZXIubmV4dCgpO1xyXG4gICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENoZWNrcyBpZiBzbW9vdGggc2Nyb2xsIGhhcyByZWFjaGVkLCBjbGVhbnMgdXAgdGhlIHNtb290aCBzY3JvbGwgc3RyZWFtXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1JlYWNoZWQoY29udGV4dDogU21vb3RoU2Nyb2xsU3RlcCwgZGVzdHJveWVkOiBTdWJqZWN0PHZvaWQ+KTogYm9vbGVhbiB7XHJcbiAgICBpZiAoY29udGV4dC5jdXJyZW50WCA9PT0gY29udGV4dC54ICYmIGNvbnRleHQuY3VycmVudFkgPT09IGNvbnRleHQueSkge1xyXG4gICAgICAvLyBJTVBPUlRBTlQ6IERlc3Ryb3kgdGhlIHN0cmVhbSB3aGVuIHNjcm9sbCBpcyByZWFjaGVkIEFTQVAhXHJcbiAgICAgIGRlc3Ryb3llZC5uZXh0KCk7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2Nyb2xsIHJlY3Vyc2l2ZWx5IHVudGlsIGNvb3JkaW5hdGVzIGFyZSByZWFjaGVkXHJcbiAgICogQHBhcmFtIGNvbnRleHRcclxuICAgKiBAcGFyYW0gZGVzdHJveWVkXHJcbiAgICovXHJcbiAgc2Nyb2xsaW5nKGNvbnRleHQ6IFNtb290aFNjcm9sbFN0ZXAsIGRlc3Ryb3llZDogU3ViamVjdDx2b2lkPik6IE9ic2VydmFibGU8dm9pZD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RlcChjb250ZXh0KS5waXBlKFxyXG4gICAgICAvLyBDb250aW51ZSB3aGlsZSB0YXJnZXQgY29vcmRpbmF0ZXMgaGFzbid0IHJlYWNoZWQgeWV0XHJcbiAgICAgIHRha2VXaGlsZSgoKSA9PiAhdGhpcy5pc1JlYWNoZWQoY29udGV4dCwgZGVzdHJveWVkKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnNjcm9sbGluZyhjb250ZXh0LCBkZXN0cm95ZWQpKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERlbGV0ZXMgdGhlIGRlc3Ryb3llciBmdW5jdGlvbiwgcnVucyBpZiB0aGUgc21vb3RoIHNjcm9sbCBoYXMgZmluaXNoZWQgb3IgaW50ZXJydXB0ZWRcclxuICAgKi9cclxuICBwcml2YXRlIG9uU2Nyb2xsUmVhY2hlZChlbDogRWxlbWVudCwgcmVzb2x2ZTogKCkgPT4gdm9pZCwgZGVzdHJveWVkOiBTdWJqZWN0PHZvaWQ+KTogdm9pZCB7XHJcbiAgICBkZXN0cm95ZWQuY29tcGxldGUoKTtcclxuICAgIHRoaXMub25Hb2luZ1Njcm9sbHMuZGVsZXRlKGVsKTtcclxuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gcmVzb2x2ZSgpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRlcm1pbmF0ZXMgYW4gb25nb2luZyBzbW9vdGggc2Nyb2xsXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbnRlcnJ1cHRlZChlbDogRWxlbWVudCwgZGVzdHJveWVkOiBTdWJqZWN0PHZvaWQ+KTogT2JzZXJ2YWJsZTxFdmVudCB8IHZvaWQ+IHtcclxuICAgIHJldHVybiBtZXJnZShcclxuICAgICAgZnJvbUV2ZW50KGVsLCAnd2hlZWwnLCB7IHBhc3NpdmU6IHRydWUsIGNhcHR1cmU6IHRydWUgfSksXHJcbiAgICAgIGZyb21FdmVudChlbCwgJ3RvdWNobW92ZScsIHsgcGFzc2l2ZTogdHJ1ZSwgY2FwdHVyZTogdHJ1ZSB9KSxcclxuICAgICAgZGVzdHJveWVkXHJcbiAgICApLnBpcGUodGFrZSgxKSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFwcGx5U2Nyb2xsVG9PcHRpb25zKGVsOiBFbGVtZW50LCBvcHRpb25zOiBTbW9vdGhTY3JvbGxUb09wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICghb3B0aW9ucy5kdXJhdGlvbikge1xyXG4gICAgICB0aGlzLnNjcm9sbEVsZW1lbnQoZWwsIG9wdGlvbnMubGVmdCwgb3B0aW9ucy50b3ApO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XHJcbiAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgLy8gSW5pdGlhbGl6ZSBhIGRlc3Ryb3llciBzdHJlYW0sIHJlaW5pdGlhbGl6ZSBpdCBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IGJlaW5nIHNjcm9sbGVkXHJcbiAgICAgICAgY29uc3QgZGVzdHJveWVkOiBTdWJqZWN0PHZvaWQ+ID0gdGhpcy5nZXRTY3JvbGxEZXN0cm95ZXJSZWYoZWwpO1xyXG5cclxuICAgICAgICBjb25zdCBjb250ZXh0OiBTbW9vdGhTY3JvbGxTdGVwID0ge1xyXG4gICAgICAgICAgc2Nyb2xsYWJsZTogZWwsXHJcbiAgICAgICAgICBzdGFydFRpbWU6IHRoaXMubm93KCksXHJcbiAgICAgICAgICBzdGFydFg6IGVsLnNjcm9sbExlZnQsXHJcbiAgICAgICAgICBzdGFydFk6IGVsLnNjcm9sbFRvcCxcclxuICAgICAgICAgIHg6IG9wdGlvbnMubGVmdCA9PSBudWxsID8gZWwuc2Nyb2xsTGVmdCA6IH5+b3B0aW9ucy5sZWZ0LFxyXG4gICAgICAgICAgeTogb3B0aW9ucy50b3AgPT0gbnVsbCA/IGVsLnNjcm9sbFRvcCA6IH5+b3B0aW9ucy50b3AsXHJcbiAgICAgICAgICBkdXJhdGlvbjogb3B0aW9ucy5kdXJhdGlvbixcclxuICAgICAgICAgIGVhc2luZzogQmV6aWVyRWFzaW5nKG9wdGlvbnMuZWFzaW5nLngxLCBvcHRpb25zLmVhc2luZy55MSwgb3B0aW9ucy5lYXNpbmcueDIsIG9wdGlvbnMuZWFzaW5nLnkyKVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nKGNvbnRleHQsIGRlc3Ryb3llZCkucGlwZShcclxuICAgICAgICAgIC8vIENvbnRpbnVlIHVudGlsIGludGVycnVwdGVkIGJ5IGFub3RoZXIgc2Nyb2xsIChuZXcgc21vb3RoIHNjcm9sbCAvIHdoZWVsIC8gdG91Y2htb3ZlKVxyXG4gICAgICAgICAgdGFrZVVudGlsKHRoaXMuaW50ZXJydXB0ZWQoZWwsIGRlc3Ryb3llZCkpLFxyXG4gICAgICAgICAgLy8gT25jZSBmaW5pc2hlZCwgY2xlYW4gdXAgdGhlIGRlc3Ryb3llciBzdHJlYW0gYW5kIHJlc29sdmUgdGhlIHByb21pc2VcclxuICAgICAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMub25TY3JvbGxSZWFjaGVkKGVsLCByZXNvbHZlLCBkZXN0cm95ZWQpKSxcclxuICAgICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2Nyb2xscyB0byB0aGUgc3BlY2lmaWVkIG9mZnNldHMuIFRoaXMgaXMgYSBub3JtYWxpemVkIHZlcnNpb24gb2YgdGhlIGJyb3dzZXIncyBuYXRpdmUgc2Nyb2xsVG9cclxuICAgKiBtZXRob2QsIHNpbmNlIGJyb3dzZXJzIGFyZSBub3QgY29uc2lzdGVudCBhYm91dCB3aGF0IHNjcm9sbExlZnQgbWVhbnMgaW4gUlRMLiBGb3IgdGhpcyBtZXRob2RcclxuICAgKiBsZWZ0IGFuZCByaWdodCBhbHdheXMgcmVmZXIgdG8gdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGUgb2YgdGhlIHNjcm9sbGluZyBjb250YWluZXIgaXJyZXNwZWN0aXZlXHJcbiAgICogb2YgdGhlIGxheW91dCBkaXJlY3Rpb24uIHN0YXJ0IGFuZCBlbmQgcmVmZXIgdG8gbGVmdCBhbmQgcmlnaHQgaW4gYW4gTFRSIGNvbnRleHQgYW5kIHZpY2UtdmVyc2FcclxuICAgKiBpbiBhbiBSVEwgY29udGV4dC5cclxuICAgKiBAcGFyYW0gc2Nyb2xsYWJsZSBlbGVtZW50XHJcbiAgICogQHBhcmFtIGN1c3RvbU9wdGlvbnMgc3BlY2lmaWVkIHRoZSBvZmZzZXRzIHRvIHNjcm9sbCB0by5cclxuICAgKi9cclxuICBzY3JvbGxUbyhzY3JvbGxhYmxlOiBTbW9vdGhTY3JvbGxFbGVtZW50LCBjdXN0b21PcHRpb25zOiBTbW9vdGhTY3JvbGxUb09wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGVsOiBFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHNjcm9sbGFibGUpO1xyXG4gICAgY29uc3QgaXNSdGw6IGJvb2xlYW4gPSBnZXRDb21wdXRlZFN0eWxlKGVsKS5kaXJlY3Rpb24gPT09ICdydGwnO1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnM6IFNtb290aFNjcm9sbFRvT3B0aW9ucyA9IHtcclxuICAgICAgLi4udGhpcy5fZGVmYXVsdE9wdGlvbnMsXHJcbiAgICAgIC4uLmN1c3RvbU9wdGlvbnMsXHJcbiAgICAgIC4uLntcclxuICAgICAgICAvLyBSZXdyaXRlIHN0YXJ0ICYgZW5kIG9mZnNldHMgYXMgcmlnaHQgb3IgbGVmdCBvZmZzZXRzLlxyXG4gICAgICAgIGxlZnQ6IGN1c3RvbU9wdGlvbnMubGVmdCA9PSBudWxsID8gKGlzUnRsID8gY3VzdG9tT3B0aW9ucy5lbmQgOiBjdXN0b21PcHRpb25zLnN0YXJ0KSA6IGN1c3RvbU9wdGlvbnMubGVmdCxcclxuICAgICAgICByaWdodDogY3VzdG9tT3B0aW9ucy5yaWdodCA9PSBudWxsID8gKGlzUnRsID8gY3VzdG9tT3B0aW9ucy5zdGFydCA6IGN1c3RvbU9wdGlvbnMuZW5kKSA6IGN1c3RvbU9wdGlvbnMucmlnaHRcclxuICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBSZXdyaXRlIHRoZSBib3R0b20gb2Zmc2V0IGFzIGEgdG9wIG9mZnNldC5cclxuICAgIGlmIChvcHRpb25zLmJvdHRvbSAhPSBudWxsKSB7XHJcbiAgICAgIG9wdGlvbnMudG9wID0gZWwuc2Nyb2xsSGVpZ2h0IC0gZWwuY2xpZW50SGVpZ2h0IC0gb3B0aW9ucy5ib3R0b207XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmV3cml0ZSB0aGUgcmlnaHQgb2Zmc2V0IGFzIGEgbGVmdCBvZmZzZXQuXHJcbiAgICBpZiAoaXNSdGwpIHtcclxuICAgICAgaWYgKG9wdGlvbnMubGVmdCAhPSBudWxsKSB7XHJcbiAgICAgICAgb3B0aW9ucy5yaWdodCA9IGVsLnNjcm9sbFdpZHRoIC0gZWwuY2xpZW50V2lkdGggLSBvcHRpb25zLmxlZnQ7XHJcbiAgICAgIH1cclxuICAgICAgb3B0aW9ucy5sZWZ0ID0gb3B0aW9ucy5yaWdodCA/IC1vcHRpb25zLnJpZ2h0IDogb3B0aW9ucy5yaWdodDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChvcHRpb25zLnJpZ2h0ICE9IG51bGwpIHtcclxuICAgICAgICBvcHRpb25zLmxlZnQgPSBlbC5zY3JvbGxXaWR0aCAtIGVsLmNsaWVudFdpZHRoIC0gb3B0aW9ucy5yaWdodDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuYXBwbHlTY3JvbGxUb09wdGlvbnMoZWwsIG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2Nyb2xsIHRvIGVsZW1lbnQgYnkgcmVmZXJlbmNlIG9yIHNlbGVjdG9yXHJcbiAgICovXHJcbiAgc2Nyb2xsVG9FbGVtZW50KHNjcm9sbGFibGU6IFNtb290aFNjcm9sbEVsZW1lbnQsIHRhcmdldDogU21vb3RoU2Nyb2xsRWxlbWVudCwgY3VzdG9tT3B0aW9uczogU21vb3RoU2Nyb2xsVG9FbGVtZW50T3B0aW9ucyA9IHt9KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBzY3JvbGxhYmxlRWw6IEVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQoc2Nyb2xsYWJsZSk7XHJcbiAgICBjb25zdCB0YXJnZXRFbDogRWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudCh0YXJnZXQsIHNjcm9sbGFibGVFbCk7XHJcbiAgICBjb25zdCBpc1J0bDogYm9vbGVhbiA9IGdldENvbXB1dGVkU3R5bGUoc2Nyb2xsYWJsZUVsKS5kaXJlY3Rpb24gPT09ICdydGwnO1xyXG5cclxuICAgIGlmICghdGFyZ2V0RWwgfHwgIXNjcm9sbGFibGVFbCkge1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2Nyb2xsYWJsZVJlY3Q6IERPTVJlY3QgPSBzY3JvbGxhYmxlRWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICBjb25zdCB0YXJnZXRSZWN0OiBET01SZWN0ID0gdGFyZ2V0RWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblxyXG4gICAgY29uc3Qgb3B0aW9uczogU21vb3RoU2Nyb2xsVG9PcHRpb25zID0ge1xyXG4gICAgICAuLi50aGlzLl9kZWZhdWx0T3B0aW9ucyxcclxuICAgICAgLi4uY3VzdG9tT3B0aW9ucyxcclxuICAgICAgLi4ue1xyXG4gICAgICAgIHRvcDogdGFyZ2V0UmVjdC50b3AgKyBzY3JvbGxhYmxlRWwuc2Nyb2xsVG9wIC0gc2Nyb2xsYWJsZVJlY3QudG9wICsgKGN1c3RvbU9wdGlvbnMudG9wIHx8IDApLFxyXG4gICAgICAgIC8vIFJld3JpdGUgc3RhcnQgJiBlbmQgb2Zmc2V0cyBhcyByaWdodCBvciBsZWZ0IG9mZnNldHMuXHJcbiAgICAgICAgbGVmdDogY3VzdG9tT3B0aW9ucy5sZWZ0ID09IG51bGwgPyAoaXNSdGwgPyBjdXN0b21PcHRpb25zLmVuZCA6IGN1c3RvbU9wdGlvbnMuc3RhcnQpIDogY3VzdG9tT3B0aW9ucy5sZWZ0LFxyXG4gICAgICAgIHJpZ2h0OiBjdXN0b21PcHRpb25zLnJpZ2h0ID09IG51bGwgPyAoaXNSdGwgPyBjdXN0b21PcHRpb25zLnN0YXJ0IDogY3VzdG9tT3B0aW9ucy5lbmQpIDogY3VzdG9tT3B0aW9ucy5yaWdodFxyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChjdXN0b21PcHRpb25zLmNlbnRlcikge1xyXG4gICAgICAvLyBDYWxjdWxhdGUgdGhlIGNlbnRlciBvZiB0aGUgY29udGFpbmVyXHJcbiAgICAgIGNvbnN0IGNvbnRhaW5lckNlbnRlclggPSBzY3JvbGxhYmxlUmVjdC5sZWZ0ICsgc2Nyb2xsYWJsZVJlY3Qud2lkdGggLyAyO1xyXG4gICAgICBjb25zdCBjb250YWluZXJDZW50ZXJZID0gc2Nyb2xsYWJsZVJlY3QudG9wICsgc2Nyb2xsYWJsZVJlY3QuaGVpZ2h0IC8gMjtcclxuXHJcbiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgdGFyZ2V0J3MgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGNvbnRhaW5lclxyXG4gICAgICBjb25zdCB0YXJnZXRDZW50ZXJYID0gdGFyZ2V0UmVjdC5sZWZ0ICsgdGFyZ2V0UmVjdC53aWR0aCAvIDI7XHJcbiAgICAgIGNvbnN0IHRhcmdldENlbnRlclkgPSB0YXJnZXRSZWN0LnRvcCArIHRhcmdldFJlY3QuaGVpZ2h0IC8gMjtcclxuXHJcbiAgICAgIC8vIENhbGN1bGF0ZSB0aGUgc2Nyb2xsIHBvc2l0aW9uIHRvIGNlbnRlciB0aGUgdGFyZ2V0IGVsZW1lbnQgaW4gdGhlIGNvbnRhaW5lclxyXG4gICAgICBvcHRpb25zLmxlZnQgPSB0YXJnZXRDZW50ZXJYIC0gY29udGFpbmVyQ2VudGVyWCArIHNjcm9sbGFibGVFbC5zY3JvbGxMZWZ0O1xyXG4gICAgICBvcHRpb25zLnRvcCA9IHRhcmdldENlbnRlclkgLSBjb250YWluZXJDZW50ZXJZICsgc2Nyb2xsYWJsZUVsLnNjcm9sbFRvcDtcclxuICAgICAgcmV0dXJuIHRoaXMuYXBwbHlTY3JvbGxUb09wdGlvbnMoc2Nyb2xsYWJsZUVsLCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3B0aW9ucy5ib3R0b20gIT0gbnVsbCkge1xyXG4gICAgICBjb25zdCBib3R0b21FZGdlOiBudW1iZXIgPSBzY3JvbGxhYmxlUmVjdC5oZWlnaHQgLSB0YXJnZXRSZWN0LmhlaWdodDtcclxuICAgICAgb3B0aW9ucy50b3AgPSB0YXJnZXRSZWN0LnRvcCArIHNjcm9sbGFibGVFbC5zY3JvbGxUb3AgLSBzY3JvbGxhYmxlUmVjdC50b3AgLSBib3R0b21FZGdlICsgKGN1c3RvbU9wdGlvbnMuYm90dG9tIHx8IDApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFJld3JpdGUgdGhlIHJpZ2h0IG9mZnNldCBhcyBhIGxlZnQgb2Zmc2V0LlxyXG4gICAgaWYgKGlzUnRsKSB7XHJcbiAgICAgIG9wdGlvbnMubGVmdCA9IHRhcmdldFJlY3QubGVmdCAtIHNjcm9sbGFibGVSZWN0LmxlZnQgKyBzY3JvbGxhYmxlRWwuc2Nyb2xsTGVmdCArIChvcHRpb25zLmxlZnQgfHwgMCk7XHJcbiAgICAgIGlmIChvcHRpb25zLnJpZ2h0ICE9IG51bGwpIHtcclxuICAgICAgICBvcHRpb25zLmxlZnQgPSB0YXJnZXRSZWN0LnJpZ2h0IC0gc2Nyb2xsYWJsZVJlY3QubGVmdCArIHNjcm9sbGFibGVFbC5zY3JvbGxMZWZ0IC0gc2Nyb2xsYWJsZVJlY3Qud2lkdGggKyAob3B0aW9ucy5yaWdodCB8fCAwKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb3B0aW9ucy5sZWZ0ID0gdGFyZ2V0UmVjdC5sZWZ0IC0gc2Nyb2xsYWJsZVJlY3QubGVmdCArIHNjcm9sbGFibGVFbC5zY3JvbGxMZWZ0ICsgKG9wdGlvbnMubGVmdCB8fCAwKTtcclxuICAgICAgaWYgKG9wdGlvbnMucmlnaHQgIT0gbnVsbCkge1xyXG4gICAgICAgIG9wdGlvbnMubGVmdCA9IHRhcmdldFJlY3QucmlnaHQgLSBzY3JvbGxhYmxlUmVjdC5sZWZ0ICsgc2Nyb2xsYWJsZUVsLnNjcm9sbExlZnQgLSBzY3JvbGxhYmxlUmVjdC53aWR0aCArIChvcHRpb25zLnJpZ2h0IHx8IDApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29tcHV0ZWRPcHRpb25zOiBTbW9vdGhTY3JvbGxUb09wdGlvbnMgPSB7XHJcbiAgICAgIHRvcDogb3B0aW9ucy50b3AsXHJcbiAgICAgIGxlZnQ6IG9wdGlvbnMubGVmdCxcclxuICAgICAgZWFzaW5nOiBvcHRpb25zLmVhc2luZyxcclxuICAgICAgZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb25cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5hcHBseVNjcm9sbFRvT3B0aW9ucyhzY3JvbGxhYmxlRWwsIGNvbXB1dGVkT3B0aW9ucyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==